agents:
  queue: "macOS-Monterey-12-4"
env:
  SAUCECTL_LABEL: "$BUILDKITE_BUILD_NUMBER $BUILDKITE_PIPELINE_SLUG $BUILDKITE_BRANCH $BUILDKITE_COMMIT"

steps:
  - command: "./scripts/unit-test-package.sh"
    label: ":xcode_simulator: Unit Test Package"
    artifact_paths:
      - ".build/artifacts/*.xcresult.zip"
  - command: "./scripts/build-package.sh"
    label: ":xcode: Build Package"
    artifact_paths:
      - ".build/artifacts/*.xcresult.zip"
  - command: "./scripts/run-integration-tests.sh"
    key: run_integration_tests
    label: ":xcode_simulator: Integration Tests"
    artifact_paths:
      - ".build/artifacts/*.xctestproducts.zip"
      - ".build/artifacts/*.xcresult.zip"
  # This may take long and could probably block another task that makes more sense.
  - command: "./scripts/run-sauce-labs-tests.sh"
    label: ":test_tube: Trigger Sauce Labs"
    depends_on: run_integration_tests
  - wait
  - command: "./scripts/version-check.sh"
    label: ":clipboard: Validate Version Metadata"
    branches: "releases/*"
  - wait
  - command: "./scripts/run-tests-swift-package-manager-ventura.sh build-only"
    label: ":swift: Build Swift Package Manager Example"
    branches: "!releases/*"
  - command: "./scripts/run-tests-swift-package-manager-ventura.sh"
    label: ":swift: Test Swift Package Manager Example"
    branches: "releases/*"
  - command: "./scripts/run-tests-cocoapods-ventura.sh build-only"
    label: ":cocoapods: Build Cocoapods Example"
    branches: "!releases/*"
  - command: "./scripts/run-tests-cocoapods-ventura.sh"
    label: ":cocoapods: Test Cocoapods Example"
    branches: "releases/*"
  - wait
  - command: "./scripts/validate-podspec.sh"
    label: ":cocoapods: Validate Podspec"
